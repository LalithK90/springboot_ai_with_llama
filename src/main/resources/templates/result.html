<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-container {
            display: flex;
            height: 100%;
        }

        #chat-history {
            width: 25%;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
        }

        #chat-history .chat-group {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        #chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
        }

        #message-input {
            display: flex;
            align-items: center;
            border-top: 1px solid #ddd;
            padding: 10px;
        }

        #message-input textarea {
            flex-grow: 1;
            margin-right: 10px;
        }

        #message-input .file-upload {
            cursor: pointer;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            max-width: 75%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user {
            margin-left: auto;
            background-color: #007bff;
            color: white;
        }

        .message.bot {
            margin-right: auto;
            background-color: #f1f1f1;
            color: black;
        }

        .message.loading {
            margin-right: auto;
            background-color: #e0e0e0;
            color: #555;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="chat-container">
    <!-- Chat History Sidebar -->
    <div id="chat-history">
        <h5 class="text-center mt-3">Chat Groups</h5>
        <button id="new-group" class="btn btn-primary w-100 mt-3">+ New Group</button>
        <div id="groups"></div>
        <button id="clear-group-chat" class="btn btn-danger w-100 mt-2">Clear Group Chat</button>
    </div>

    <!-- Chat Window -->
    <div id="chat-window">
        <div id="messages"></div>
        <div id="message-input">
            <button id="file-upload-btn" class="btn btn-light file-upload">
                <i class="fas fa-file-upload"></i>
            </button>
            <textarea id="message-text" class="form-control" rows="1" placeholder="Type a message..."></textarea>
            <button id="send-btn" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // Manage chat history and groups in local storage
    const LOCAL_STORAGE_KEY = "chatHistory";
    const DEFAULT_GROUP_NAME = "Default";
    const chatHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || {};

    let currentGroup = DEFAULT_GROUP_NAME;

    // Initialize groups and messages
    function initialize() {
        if (!chatHistory[DEFAULT_GROUP_NAME]) {
            chatHistory[DEFAULT_GROUP_NAME] = [];
        }
        renderGroups();
        renderMessages();
    }

    // Render chat groups
    function renderGroups() {
        $("#groups").empty();
        Object.keys(chatHistory).forEach(group => {
            $("#groups").append(
                `<div class="chat-group" data-group="${group}">${group}</div>`
            );
        });
    }

    // Render messages for the current group
    function renderMessages() {
        const messages = chatHistory[currentGroup] || [];
        $("#messages").empty();
        messages.forEach(msg => {
            $("#messages").append(
                `<div class="message ${msg.sender}">${msg.text}</div>`
            );
        });
    }

    // Send message to the API
    function sendMessage() {
        const text = $("#message-text").val().trim();
        if (!text) return;

        chatHistory[currentGroup].push({sender: "user", text});
        saveChatHistory();
        renderMessages();
        $("#message-text").val("");

        const loadingIndicator = $('<div class="message loading">Typing...</div>');
        $("#messages").append(loadingIndicator);

        $.ajax({
            url: `http://localhost:9292/chat?prompt=${encodeURIComponent(text)}`,
            method: "GET",
            success: function (response) {
                loadingIndicator.remove();
                chatHistory[currentGroup].push({sender: "bot", text: response});
                saveChatHistory();
                renderMessages();
            },
            error: function () {
                loadingIndicator.remove();
                Swal.fire("Error", "Failed to connect to the chat API!", "error");
            }
        });
    }

    // Upload file to the API using SweetAlert modal
    function uploadFile() {
        Swal.fire({
            title: 'Upload a File',
            input: 'file',
            inputAttributes: {
                'accept': 'application/pdf, .xlsx, .txt, .docx',
                'aria-label': 'Upload a file'
            },
            showCancelButton: true,
            confirmButtonText: 'Upload',
            showLoaderOnConfirm: true,
            preConfirm: (file) => {
                if (!file) {
                    Swal.showValidationMessage('Please select a file');
                    return false;
                }

                const formData = new FormData();
                formData.append("file", file);
                return $.ajax({
                    url: "http://localhost:9292/fileUpload",
                    method: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        Swal.fire('Success', 'File uploaded successfully!', 'success');
                    },
                    error: function () {
                        Swal.fire('Error', 'Failed to upload the file.', 'error');
                    }
                });
            }
        });
    }

    // Clear group chat history
    function clearGroupChat() {
        Swal.fire({
            title: "Are you sure?",
            text: `This will delete all messages in the "${currentGroup}" group.`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, clear it!"
        }).then(result => {
            if (result.isConfirmed) {
                // chatHistory[currentGroup] = [];
                Object.keys(chatHistory).some(group => {
                    if (group === currentGroup) {
                        delete chatHistory[group];
                        return true; // Breaks the iteration
                    }
                    return false; // Continue iteration
                });
                renderGroups()
                saveChatHistory();
                renderMessages();
                Swal.fire("Cleared!", "Group chat has been cleared.", "success");
            }
        });
    }

    // Save chat history to local storage
    function saveChatHistory() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(chatHistory));
    }

    // Create a new group
    function createNewGroup() {
        const groupName = prompt("Enter a name for the new group:");
        if (groupName && !chatHistory[groupName]) {
            chatHistory[groupName] = [];
            saveChatHistory();
            currentGroup = groupName;
            renderGroups();
            renderMessages();
        }
    }

    // Switch to a different group
    $(document).on("click", ".chat-group", function () {
        const groupName = $(this).data("group");
        currentGroup = groupName;
        renderMessages();
    });

    // Event listeners
    $("#send-btn").click(sendMessage);
    $("#file-upload-btn").click(uploadFile);
    $("#clear-group-chat").click(clearGroupChat);
    $("#new-group").click(createNewGroup);

    // Initialize the chat client
    $(document).ready(initialize);
</script>
</body>
</html>
